<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>JustGo Audit</title>
    <style>
      html, body {
        height:100%; margin:0; overflow:auto;
        font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
        background:#fff;
      }

      .wrap{
        --panel:#FFFFFF; --panel-border:#E8EAEE; --text:#000; --muted:#6B7280;
        --accent:#4CAF4F; --accent-ink:#4CAF4F; --accent-50:#ECF4EC;
        --chip:#FFFFFF; --chip-border:#F0F0F0;

        --success-bg:#E9F6EA; --success-border:#CFEBD2; --success-ink:#1B5E20;
        --warn-bg:#FFF8DF; --warn-border:#FAE8A8; --warn-ink:#7B5F00;
        --error-bg:#FFE8EA; --error-border:#F6C3C7; --error-ink:#B00020;

        /* Tips card theme (green with black text & border) */
        --tips-bg:#F8FCF8;
        --tips-border:#0000000e;
        --tips-ink:#000000;
        --tips-radius:8px;

        min-height:100vh; padding:20px; background:#fff; color:var(--text);
      }
      .wrap *{ box-sizing:border-box; }

      .wrap .header{ text-align:center; margin-bottom:18px; }
      .wrap .title{ font-size:16px; font-weight:600; margin:0 0 4px; }
      .wrap .subtitle{ font-size:14px; line-height:20px; color:var(--muted); max-width:560px; margin:0 auto; }

      .wrap .tabs{ display:flex; gap:0; padding:6px; border:1px solid #F0F0F0; border-radius:8px; background:#FAFAFA; margin:16px 0; }
      .wrap .tab{ flex:1; border:0; background:transparent; border-radius:12px; padding:10px 12px; font-size:14px; line-height:20px; font-weight:500; color:#737373; cursor:pointer; transition:all .15s ease; }
      .wrap .tab.active{ background:#fff; color:#000; border-radius:4px; box-shadow:0 1px 3px rgba(0,0,0,.06), 0 4px 8px 3px rgba(0,0,0,.04); }

      .wrap .card{ background:#FAFAFA; border:1px solid #F0F0F0; border-radius:12px; padding:16px; }
      .wrap .section-title{ font-size:14px; font-weight:600; margin:0 0 6px; color:#000; }
      .wrap .section-note{ font-size:14px; line-height: 20px; color:#737373; margin:0 0 12px; }

      .wrap .quick-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
      .wrap .chip{ background:var(--chip); border:1px solid var(--chip-border); border-radius:8px; padding:14px 16px; text-align:center; cursor:pointer; font-weight:500; font-size:14px; color:#000000; transition:all .15s ease; }
      .wrap .chip:hover{ background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.06), 0 4px 8px 3px rgba(0,0,0,.04); }
      .wrap .chip.selected{ background:var(--accent-50); border-color:var(--accent); color:var(--accent-ink); }

      .wrap .label{ display:block; font-weight:600; margin:12px 0 6px; font-size:14px; }
      .wrap .hint{ color:#757575; font-size:14px; line-height: 20px; margin:0 0 8px; }
      .wrap .input{ width:100%; border:1px solid #E6E6E6; border-radius:8px; padding:10px 12px; font-size:14px; outline:none; background:#fff; }
      .wrap .input:focus{ border-color:#4CAF4F; }

      .wrap .btn{ width:100%; margin-top:14px; padding:12px 14px; border:0; border-radius:8px; background:var(--accent); color:#fff; font-weight:600; font-size:14px; cursor:pointer; }
      .wrap .btn:hover{ box-shadow:0 1px 3px rgba(0,0,0,.06), 0 4px 8px 3px rgba(0,0,0,.04); }

      .wrap .status{
        font-size:14px; margin-top:12px; border-radius:8px; padding:12px; display:flex; align-items:flex-start; gap:8px;
        border:1px solid var(--warn-border); background:var(--warn-bg); color:var(--warn-ink); font-weight:400;
      }
      .wrap .status.success{ background:var(--success-bg); border-color:var(--success-border); color:var(--success-ink); }
      .wrap .status.warning{ background:var(--warn-bg); border-color:var(--warn-border); color:var(--warn-ink); }
      .wrap .status.error{ background:var(--error-bg); border-color:var(--error-border); color:var(--error-ink); }
      .wrap .status .badge{ width:14px; height:14px; display:grid; place-items:center; border-radius:50%; font-size:14px; line-height:1; margin-top:1px; background:#4CAF4F; color:#fff; }
      .wrap .status.success .badge{ background:#1B5E20; }
      .wrap .status.warning .badge{ background:#7B5F00; }
      .wrap .status.error .badge{ background:#B00020; }

      .wrap .stats{ margin-top:14px; }
      .wrap .stats-card{ background:#fff; border:1px solid var(--panel-border); border-radius:8px; padding:16px; }
      .wrap .stats-title{ font-size:14px; font-weight:600; margin:0 0 4px; }
      .wrap .stats-context{ color:#757575; font-size:14px; margin-bottom:12px; }
      .wrap .kpis{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
      .wrap .kpi{ background:#FAFAFA; border-radius:8px; padding:16px; text-align:center; }
      .wrap .kpi .num{ font-size:20px; font-weight:600; color:#000; }
      .wrap .kpi .sub{ font-size:12px; color:#737373; margin-top:6px; }

      .wrap .results-title{ font-size:14px; font-weight:600; margin:16px 0 8px; }
      .wrap .results-list{ display:grid; gap:12px; }
      .wrap .result{ border:1px solid var(--panel-border); border-radius:8px; background:#fff; padding:16px; cursor:pointer; }
      .wrap .result:hover{ box-shadow:0 1px 3px rgba(0,0,0,.06), 0 4px 8px 3px rgba(0,0,0,.04); }
      .wrap .result:focus{ outline:2px solid #4CAF4F; outline-offset:2px; }
      .wrap .result .name{ font-size:14px; font-weight:600; margin-bottom:6px; }
      .wrap .result .path{ font-size:14px; line-height:24px; color:#757575; word-break:break-word; }

      .wrap .hidden{ display:none !important; }

      /* Tips card */
      .tips{
        background:var(--tips-bg);
        border:1px solid var(--tips-border);
        border-radius:var(--tips-radius);
        color:var(--tips-ink);
        padding:16px 16px;
        margin-top:16px;
      }
      .tips-title{ font-size: 14px; font-weight:600; color: #727472; margin:0 0 6px; }
      .tips-list{ margin:0; padding-left:1.2em; list-style:disc; }
      .tips-list li{ font-size: 14px; font-weight: 400; color: #727472; margin:6px 0; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <h1 class="title">JustGo Audit</h1>
        <p class="subtitle">Design System Audit Solution for detecting variables, styles, and exact layer names, complete with quality assurance features.</p>
      </div>

      <div class="tabs">
        <button id="variables-tab" class="tab active">Variable & Styles</button>
        <button id="layers-tab" class="tab">Layer Names</button>
      </div>

      <!-- Layer Names -->
      <div id="layers-mode" class="hidden">
        <div class="section-title">Select layer name</div>
        <div class="section-note">You can only search within that list. Click to select a suggested text layer name for auditing.</div>
        <div id="quick-buttons" class="quick-grid card" aria-label="Suggested names">
          <div class="chip" data-layer="heading-text" role="button" aria-selected="false">heading-text</div>
          <div class="chip" data-layer="title-text" role="button" aria-selected="false">title-text</div>
          <div class="chip" data-layer="subtitle-text" role="button" aria-selected="false">subtitle-text</div>
          <div class="chip" data-layer="body-text" role="button" aria-selected="false">body-text</div>
          <div class="chip" data-layer="highlighted-text" role="button" aria-selected="false">highlighted-text</div>
          <div class="chip" data-layer="info-text" role="button" aria-selected="false">info-text</div>
          <div class="chip" data-layer="caption-text" role="button" aria-selected="false">caption-text</div>
          <div class="chip" data-layer="overline-text" role="button" aria-selected="false">overline-text</div>
        </div>
      </div>

      <!-- Variables & Styles -->
      <div id="variables-mode">
        <label id="search-label" class="label">Enter variable or style name (exact match)</label>
        <div id="search-hint" class="hint">Type the full name (e.g. <code>colors/warning/100</code>) or the base name exactly (e.g. <code>warning/100</code>).</div>
        <input id="search-input" class="input" type="text" placeholder="e.g. colors/warning/100"/>
      </div>

      <button id="search-button" class="btn"><span id="search-text">Find</span></button>

      <div id="status" class="status hidden" role="status" aria-live="polite">
        <div class="badge">✓</div>
        <div id="status-text"></div>
      </div>

      <div id="search-stats" class="stats hidden">
        <div class="stats-card">
          <div class="stats-title">Audit Statistics</div>
          <div id="stats-context" class="stats-context"></div>
          <div class="kpis">
            <div class="kpi"><div id="stat-checked" class="num">0</div><div class="sub">Nodes<br/>Audited</div></div>
            <div class="kpi"><div id="stat-with-items" class="num">0</div><div class="sub">Design<br/>Tokens</div></div>
            <div class="kpi"><div id="stat-matching" class="num">0</div><div class="sub">Matching<br/>Criteria</div></div>
          </div>

          <!-- Hidden by default; only shown when there are results -->
          <div id="results-title" class="results-title hidden">Audit Results</div>
          <div id="results-container"></div>
        </div>
      </div>
    </div>

    <script>
      const el = {
        input: document.getElementById("search-input"),
        button: document.getElementById("search-button"),
        text: document.getElementById("search-text"),
        status: document.getElementById("status"),
        statusText: document.getElementById("status-text"),
        variablesTab: document.getElementById("variables-tab"),
        layersTab: document.getElementById("layers-tab"),
        variablesMode: document.getElementById("variables-mode"),
        layersMode: document.getElementById("layers-mode"),
        quickButtons: document.getElementById("quick-buttons"),
        stats: document.getElementById("search-stats"),
        statsContext: document.getElementById("stats-context"),
        statChecked: document.getElementById("stat-checked"),
        statWithItems: document.getElementById("stat-with-items"),
        statMatching: document.getElementById("stat-matching"),
        resultsTitle: document.getElementById("results-title"),
        container: document.getElementById("results-container")
      };

      let currentMode = "variables";

      function setStatus(message, type){
        el.statusText.textContent = message;
        el.status.className = "status " + (type || "");
        el.status.classList.remove("hidden");
        const badge = el.status.querySelector(".badge");
        if (type === "success") badge.textContent = "✓";
        else if (type === "warning") badge.textContent = "!";
        else if (type === "error") badge.textContent = "×";
        else badge.textContent = "•";
      }
      function hideStatus(){ el.status.classList.add("hidden"); }
      function setSearching(s){
        el.button.disabled = s;
        el.text.textContent = s ? (currentMode === "variables" ? "Auditing design tokens..." : "Auditing layer names...") : "Find";
      }

      function switchMode(mode){
        currentMode = mode;
        el.variablesTab.classList.toggle("active", mode === "variables");
        el.layersTab.classList.toggle("active", mode === "layers");
        el.variablesMode.classList.toggle("hidden", mode !== "variables");
        el.layersMode.classList.toggle("hidden", mode !== "layers");

        if (el.quickButtons){
          Array.prototype.forEach.call(el.quickButtons.children, (btn)=>{
            btn.classList.remove("selected"); btn.setAttribute("aria-selected","false");
          });
        }
        el.input.value = "";

        hideStatus();
        el.stats.classList.add("hidden");
        el.container.innerHTML = "";
        el.resultsTitle.classList.add("hidden"); // hide heading on mode switch
      }

      function renderStats(stats, context){
        el.statsContext.textContent = context ? ("Page: " + context) : "";
        el.statChecked.textContent = stats.checkedNodes;
        el.statWithItems.textContent = stats.nodesWithItems;
        el.statMatching.textContent = stats.matchingNodes;
        el.stats.classList.remove("hidden");
      }

      function renderEmpty(term, type){
        const html = type === "LAYER_NAME"
          ? `<div class="tips">
               <div class="tips-title">💡 Tips:</div>
               <ul class="tips-list">
                 <li>Only exact layer name matching</li>
                 <li>Components &amp; instances excluded</li>
                 <li>Use allowed names only</li>
               </ul>
             </div>`
          : `<div class="tips">
               <div class="tips-title">💡 Tips:</div>
               <ul class="tips-list">
                 <li>Exact match only (full name or base segment)</li>
                 <li>Searches selection first, then page</li>
                 <li>Matches Variables &amp; Styles</li>
               </ul>
             </div>`;
        el.container.innerHTML = html;
        el.resultsTitle.classList.add("hidden"); // keep "Audit Results" hidden when empty
      }

      function renderResults(results){
        el.resultsTitle.classList.remove("hidden"); // show heading only when we have results
        const list = document.createElement("div");
        list.className = "results-list";
        const frag = document.createDocumentFragment();
        for (let i=0;i<results.length;i++){
          const r = results[i];
          const card = document.createElement("div");
          card.className = "result";
          card.setAttribute("data-id", r.id);
          card.setAttribute("role", "button"); // accessibility + keyboard
          card.tabIndex = 0;
          card.innerHTML = `
            <div class="name">${r.name}</div>
            <div class="path">${(r.path||"").split("→").join(" → ")}</div>`;
          frag.appendChild(card);
        }
        list.appendChild(frag);
        el.container.innerHTML = "";
        el.container.appendChild(list);
      }

      /* Events & bridge */
      el.button.addEventListener("click", ()=>{
        const term = (el.input.value || "").trim();
        if (currentMode === "layers" && !term){ setStatus("Please select a layer name first.", "warning"); return; }
        if (currentMode === "variables" && !term){ setStatus("Please enter a variable or style name.", "warning"); return; }
        setSearching(true); hideStatus();
        const type = currentMode === "variables" ? "find-variables-and-styles" : "find-layer-names";
        parent.postMessage({ pluginMessage: { type, searchTerm: term } }, "*");
      });

      // Enter submits in BOTH modes
      el.input.addEventListener("keypress",(e)=>{ if (e.key==="Enter") el.button.click(); });

      el.variablesTab.addEventListener("click", ()=> switchMode("variables"));
      el.layersTab.addEventListener("click",    ()=> switchMode("layers"));

      if (el.quickButtons){
        el.quickButtons.addEventListener("click", (ev)=>{
          const btn = ev.target.closest(".chip"); if (!btn) return;
          Array.prototype.forEach.call(el.quickButtons.children,(c)=>{ c.classList.remove("selected"); c.setAttribute("aria-selected","false"); });
          btn.classList.add("selected"); btn.setAttribute("aria-selected","true");
          el.input.value = btn.dataset.layer; // still need to click Find
        });
      }

      // Click result card -> select & zoom in editor
      el.container.addEventListener("click", (e)=>{
        const card = e.target.closest(".result"); if (!card) return;
        const id = card.getAttribute("data-id");  if (!id) return;
        parent.postMessage({ pluginMessage: { type: "select-node", id } }, "*");
      });

      // Keyboard: Enter / Space on focused card
      el.container.addEventListener("keydown", (e)=>{
        if (e.key !== "Enter" && e.key !== " ") return;
        const card = e.target.closest(".result"); if (!card) return;
        const id = card.getAttribute("data-id");  if (!id) return;
        e.preventDefault();
        parent.postMessage({ pluginMessage: { type: "select-node", id } }, "*");
      });

      // Messages from plugin
      window.addEventListener("message",(event)=>{
        const msg = event.data && event.data.pluginMessage; if (!msg) return;

        if (msg.type === "search-results"){
          setSearching(false);
          if (msg.searchStatistics) renderStats(msg.searchStatistics, msg.context);

          if (msg.searchType === "LAYER_NAME"){
            if (msg.strictError) setStatus("🔒 " + msg.strictError, "error");
            else if (msg.results.length) setStatus(`${msg.results.length} layers named "${msg.searchTerm}" found.`, "success");
            else setStatus(`No layers named "${msg.searchTerm}" found.`, "warning");
          } else {
            if (msg.results.length) setStatus(`Audit found ${msg.results.length} layers using "${msg.searchTerm}".`, "success");
            else setStatus(`No layers found using "${msg.searchTerm}".`, "warning");
          }

          if (!msg.results.length) renderEmpty(msg.searchTerm, msg.searchType);
          else renderResults(msg.results);

        } else if (msg.type === "select-node:ok"){
          if (msg.exact) setStatus("Layer selected.", "success");
          else if (msg.reason === "inside-instance-child") setStatus("Selected the owning Instance (children inside instances can’t be selected).", "warning");
          else if (msg.reason === "locked-or-hidden") setStatus("Selected the nearest visible & unlocked parent (target is locked/hidden).", "warning");
          else setStatus("Selected parent container.", "warning");

        } else if (msg.type === "select-node:blocked"){
          const b = msg.blocker ? ` — blocked by ${msg.blocker.type} “${msg.blocker.name || "Unnamed"}”` : "";
          const bits = [];
          if (msg.insideInstance) bits.push("inside an Instance");
          if (msg.locked) bits.push("locked");
          if (msg.hidden) bits.push("hidden");
          const why = bits.length ? ` (${bits.join(", ")})` : "";
          setStatus(`Can’t select that exact layer${why}${b}. Figma prevents selecting it without changing layer state.`, "error");

        } else if (msg.type === "select-node:fail"){
          const reason = msg.reason ? ` (${msg.reason}${msg.detail ? ": " + msg.detail : ""})` : "";
          setStatus(`Couldn’t select that layer${reason}.`, "error");

        } else if (msg.type === "error"){
          setSearching(false);
          setStatus(msg.message || "Something went wrong.", "error");
        }
      });

      // Default view → Variables & Styles tab active
      switchMode("variables");
    </script>
  </body>
</html>
